services:
  prompt-composer:
    build:
      context: ..
      target: development
    ports:
      - "3000:4321"
    environment:
      - LLM=http://mock-llm:3001  # comment this if you want to work with real LLM
    depends_on:
      - mock-llm
    secrets:
      - llm_api_key
    volumes:
      - ./mock_shared_data:/app/data
      - ../src:/app/src

  mock-llm:
    image: node:22-alpine
    stop_grace_period: 0s
    command:
      - node
      - -e
      - |
        require('http').createServer((req, res) => {
          res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({candidates:[{content:{parts:[{text: 'This is the mock response'}]}}]}));
        }).listen(3001);

  auto-test:
    image: node:22-alpine
    stop_grace_period: 0s
    working_dir: /app
    command: sh -c "npm install -g nodemon && nodemon --watch src/server.js --delay 1 test/test.mjs"
    volumes:
      - ../:/app/
      - nodemon-cache:/usr/local/lib/node_modules
    depends_on:
      - prompt-composer

volumes:
  nodemon-cache:

secrets:
  llm_api_key:
    file: ./secrets/llm_api_key
